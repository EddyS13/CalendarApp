<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Event Calendar</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel for JSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase CDN imports -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, doc, updateDoc, deleteDoc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    window.firebase = {
      initializeApp,
      getAuth,
      signInWithCustomToken,
      signInAnonymously,
      getFirestore,
      collection,
      onSnapshot,
      addDoc,
      serverTimestamp,
      doc,
      updateDoc,
      deleteDoc,
      getDocs,
      setDoc,
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;700&display=swap');
    body {
      font-family: 'Segoe UI', sans-serif;
    }
    .bg-custom-green {
      background-color: #94C926;
    }
    .bg-custom-dark {
      background-color: #4A5568;
    }
    .text-custom-blue {
      color: #0099b5;
    }
    .calendar-event {
        font-size: 12px;
        font-family: 'Segoe UI', sans-serif;
        color: white;
        border-radius: 0.375rem;
        padding: 0.25rem;
        overflow-wrap: break-word;
        white-space: normal;
        cursor: pointer;
        transition-property: transform;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
        overflow-y: auto;
    }
    .calendar-event:hover {
        transform: scale(1.05);
    }
  </style>
</head>
<body class="bg-[#27251F] font-sans antialiased">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const {
      initializeApp,
      getAuth,
      signInWithCustomToken,
      signInAnonymously,
      getFirestore,
      collection,
      onSnapshot,
      addDoc,
      serverTimestamp,
      doc,
      updateDoc,
      deleteDoc,
      getDocs,
      setDoc,
    } = window.firebase;

    // IMPORTANT: PASTE YOUR UNIQUE FIREBASE CONFIG HERE
    const firebaseConfig = {
      apiKey: "AIzaSyCWG0iyIuLUaR2zfxVaYHjdZ2Tv98bNZq4",
      authDomain: "calendar-app-ad298.firebaseapp.com",
      projectId: "calendar-app-ad298",
      storageBucket: "calendar-app-ad298.firebasestorage.app",
      messagingSenderId: "557919844479",
      appId: "1:557919844479:web:c3189c4141b267be37274a",
      measurementId: "G-P6M3VC9V3Y"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const adminCredentials = {
      'admin1': 'password1',
      'admin2': 'password2'
    };
    
    // Message Modal Component
    const MessageModal = ({ message, onConfirm, onCancel, showConfirm = false }) => {
      if (!message) return null;
      return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto">
            <p className="text-gray-800 text-lg text-center mb-4">{message}</p>
            <div className="flex justify-center space-x-4">
              {showConfirm && (
                <button
                  onClick={onConfirm}
                  className="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors"
                >
                  Confirm
                </button>
              )}
              <button
                onClick={onCancel}
                className="px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 transition-colors"
              >
                {showConfirm ? 'Cancel' : 'OK'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Admin Login Modal
    const AdminLoginModal = ({ onLogin, onClose, modalMessage, setModalMessage }) => {
      const [adminUsername, setAdminUsername] = useState('');
      const [adminPassword, setAdminPassword] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        onLogin(adminUsername, adminPassword);
      };

      return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
          <div className="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-auto">
            <h2 className="text-2xl font-bold mb-4 text-center">Admin Login</h2>
            {modalMessage && <p className="text-red-500 text-sm text-center mb-4">{modalMessage}</p>}
            <form onSubmit={handleSubmit} className="flex flex-col space-y-4">
              <input
                type="text"
                placeholder="Username"
                value={adminUsername}
                onChange={(e) => setAdminUsername(e.target.value)}
                className="p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <input
                type="password"
                placeholder="Password"
                value={adminPassword}
                onChange={(e) => setAdminPassword(e.target.value)}
                className="p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                type="submit"
                className="px-6 py-3 text-white font-semibold rounded-lg shadow-md transition-colors bg-custom-green hover:bg-green-700"
              >
                Log In
              </button>
            </form>
            <div className="flex justify-center mt-4">
              <button
                onClick={onClose}
                className="px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      );
    };

    // New Event Details Modal Component
    const EventDetailsModal = ({ event, onClose, userId, isAdmin, categories, tags }) => {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [isRegistered, setIsRegistered] = useState(false);
      const [showAdminDetails, setShowAdminDetails] = useState(false);
      const [modalMessage, setModalMessage] = useState('');

      useEffect(() => {
        if (event.registeredUsers && event.registeredUsers.some(user => user.userId === userId)) {
          setIsRegistered(true);
        } else {
          setIsRegistered(false);
        }
      }, [event, userId]);

      const handleRegister = async () => {
        if (!name || !email) {
          setModalMessage('Please enter your name and email to register.');
          return;
        }
        
        const isAlreadyRegistered = event.registeredUsers.some(user => user.email === email);
        if (isAlreadyRegistered) {
          setModalMessage('This email is already registered for this event.');
          return;
        }

        try {
          const eventsCollectionPath = `/artifacts/${firebaseConfig.projectId}/public/data/calendarEvents`;
          const eventRef = doc(db, eventsCollectionPath, event.id);

          const newRegisteredUser = {
            userId: userId,
            name: name,
            email: email,
            registeredAt: new Date()
          };
          
          const updatedRegisteredUsers = event.registeredUsers ? [...event.registeredUsers, newRegisteredUser] : [newRegisteredUser];
          
          await updateDoc(eventRef, {
            registeredUsers: updatedRegisteredUsers
          });

          setIsRegistered(true);
          setModalMessage('You have been successfully registered!');
        } catch (error) {
          setModalMessage(`Error registering: ${error.message}. Please check your Firestore rules.`);
          console.error('Error registering:', error);
        }
      };
      
      const formattedDateOnly = event.date.toDate().toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });
      
      const formattedTimeOnly = event.date.toDate().toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
      });

      const registeredCount = event.registeredUsers ? event.registeredUsers.length : 0;
      const remainingSlots = event.totalVolunteers ? event.totalVolunteers - registeredCount : 'N/A';

      const tagArray = event.tags ? (Array.isArray(event.tags) ? event.tags : [event.tags]) : [];
      const categoryColor = categories.find(cat => cat.name === event.category)?.color || '#4A5568';
      const eventTagsWithColors = tagArray.map(tagName => tags.find(tag => tag.name === tagName));

      return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
          <div className="bg-white p-8 rounded-lg shadow-xl max-w-lg mx-auto transform transition-all scale-100 opacity-100">
            {modalMessage && <MessageModal message={modalMessage} onCancel={() => setModalMessage('')} />}
            <h2 className="text-3xl font-bold mb-2">{event.title}</h2>
            <div className="space-y-2 text-gray-700 mb-4">
              <p><strong>Date:</strong> {formattedDateOnly}</p>
              <p><strong>Time:</strong> {formattedTimeOnly}</p>
              <p><strong>Category:</strong> <span style={{ backgroundColor: categoryColor }} className="px-2 py-1 rounded text-white text-xs font-semibold">{event.category}</span></p>
              <p><strong>Description:</strong> {event.description}</p>
              {eventTagsWithColors.length > 0 && (
                <div className="flex flex-wrap gap-2 items-center">
                  <strong>Tags:</strong>
                  {eventTagsWithColors.map((tag, index) => (
                    tag ? <span key={index} style={{ backgroundColor: tag.color }} className="px-2.5 py-0.5 rounded-full text-white text-xs font-semibold">{tag.name}</span> : null
                  ))}
                </div>
              )}
            </div>
            
            <div className="mt-4 border-t-2 pt-4">
              <h3 className="text-lg font-bold mb-2">Volunteer Positions</h3>
              <p className="text-sm font-semibold text-gray-600 mb-4">
                Remaining: {remainingSlots} out of {event.totalVolunteers} available
              </p>
              
              {isAdmin ? (
                <div className="mt-4 border-t-2 pt-4">
                  <h3 className="font-bold text-lg mb-2">Registered Users ({registeredCount})</h3>
                  <button
                    onClick={() => setShowAdminDetails(!showAdminDetails)}
                    className="text-sm text-blue-500 hover:underline"
                  >
                    {showAdminDetails ? 'Hide Details' : 'Show Details'}
                  </button>
                  {showAdminDetails && (
                    <ul className="mt-2 list-disc list-inside space-y-1 text-sm">
                      {event.registeredUsers && event.registeredUsers.map((user, index) => (
                        <li key={index}>{user.name} ({user.email})</li>
                      ))}
                    </ul>
                  )}
                </div>
              ) : (
                <div className="flex flex-col space-y-3">
                  <input
                    type="text"
                    placeholder="Your Name"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    className="p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <input
                    type="email"
                    placeholder="Your Email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <div className="flex justify-end space-x-4 mt-4">
                    <button
                      onClick={handleRegister}
                      className={`px-4 py-2 text-white font-semibold rounded-lg shadow-md transition-colors bg-custom-green ${
                        isRegistered ? 'cursor-not-allowed' : 'hover:bg-green-700'
                      }`}
                      disabled={isRegistered}
                    >
                      {isRegistered ? 'Signed Up!' : 'Sign up to be a volunteer'}
                    </button>
                  </div>
                </div>
              )}
            </div>
            
            <div className="flex justify-end mt-4">
              <button
                onClick={onClose}
                className="px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 transition-colors"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Main App component
    const App = () => {
      // State for Firebase and user
      const [userId, setUserId] = useState(null);
      const [isAuthReady, setIsAuthReady] = useState(false);
      
      // State for admin access and new event form
      const [isAdmin, setIsAdmin] = useState(false);
      const [showAdminLoginModal, setShowAdminLoginModal] = useState(false);
      const [modalMessage, setModalMessage] = useState('');
      const [showConfirm, setShowConfirm] = useState(false);
      const [modalAction, setModalAction] = useState(null);
      const [selectedEvent, setSelectedEvent] = useState(null);
      const [activeUsers, setActiveUsers] = useState([]);
      const [adminTab, setAdminTab] = useState('create');
      
      // Admin form state
      const [newEventTitle, setNewEventTitle] = useState('');
      const [newEventDate, setNewEventDate] = useState('');
      const [newEventTime, setNewEventTime] = useState('12:00');
      const [newEventDescription, setNewEventDescription] = useState('');
      const [newEventCategory, setNewEventCategory] = useState('');
      const [newEventTags, setNewEventTags] = useState('');
      const [newEventVolunteers, setNewEventVolunteers] = useState(0);
      const [editingEvent, setEditingEvent] = useState(null);
      
      // Manage Tags/Categories state
      const [tags, setTags] = useState([]);
      const [newTagName, setNewTagName] = useState('');
      const [newTagColor, setNewTagColor] = useState('#000000');
      const [categories, setCategories] = useState([]);
      const [newCategoryName, setNewCategoryName] = useState('');
      const [newCategoryColor, setNewCategoryColor] = useState('#000000');

      // State for calendar and events
      const [currentDate, setCurrentDate] = useState(new Date());
      const [events, setEvents] = useState([]);
      
      const adminCredentials = {
        'admin1': 'password1',
        'admin2': 'password2'
      };

      // Firebase Authentication
      useEffect(() => {
        const initAuth = async () => {
          try {
            await signInAnonymously(auth);

            auth.onAuthStateChanged(user => {
              if (user) {
                setUserId(user.uid);
                setIsAuthReady(true);
                // Track user activity
                const userDocRef = doc(db, `/artifacts/${firebaseConfig.projectId}/public/data/activeUsers`, user.uid);
                setDoc(userDocRef, {
                  lastLogin: serverTimestamp(),
                }, { merge: true });
              } else {
                setUserId(crypto.randomUUID());
                setIsAuthReady(true);
              }
            });
          } catch (error) {
            setModalMessage("Firebase authentication failed. Please check your firebaseConfig object and ensure Anonymous Sign-in is enabled in your Firebase console.");
            console.error("Firebase authentication failed:", error);
          }
        };
        initAuth();
      }, []);

      // Fetch events from Firestore in real-time
      useEffect(() => {
        if (!isAuthReady) return;
        const eventsCollectionPath = `/artifacts/${firebaseConfig.projectId}/public/data/calendarEvents`;
        const q = collection(db, eventsCollectionPath);
        
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
          const fetchedEvents = [];
          querySnapshot.forEach((doc) => {
            fetchedEvents.push({ ...doc.data(), id: doc.id });
          });
          setEvents(fetchedEvents);
        }, (error) => {
          setModalMessage("Error fetching events.");
          console.error("Error fetching events:", error);
        });

        return () => unsubscribe();
      }, [db, isAuthReady]);
      
      // Fetch tags
      useEffect(() => {
        if (!isAuthReady) return;
        const tagsCollectionPath = `/artifacts/${firebaseConfig.projectId}/public/data/eventTags`;
        const q = collection(db, tagsCollectionPath);
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
          const fetchedTags = [];
          querySnapshot.forEach((doc) => {
            fetchedTags.push({ ...doc.data(), id: doc.id });
          });
          setTags(fetchedTags);
        }, (error) => {
          console.error("Error fetching tags:", error);
        });
        return () => unsubscribe();
      }, [db, isAuthReady]);

      // Fetch categories
      useEffect(() => {
        if (!isAuthReady) return;
        const categoriesCollectionPath = `/artifacts/${firebaseConfig.projectId}/public/data/eventCategories`;
        const q = collection(db, categoriesCollectionPath);
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
          const fetchedCategories = [];
          querySnapshot.forEach((doc) => {
            fetchedCategories.push({ ...doc.data(), id: doc.id });
          });
          setCategories(fetchedCategories);
        }, (error) => {
          console.error("Error fetching categories:", error);
        });
        return () => unsubscribe();
      }, [db, isAuthReady]);

      // Fetch active users for admin panel
      useEffect(() => {
        if (!isAdmin) return;
        const activeUsersCollectionPath = `/artifacts/${firebaseConfig.projectId}/public/data/activeUsers`;
        const q = collection(db, activeUsersCollectionPath);
        
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
          const fetchedUsers = [];
          querySnapshot.forEach((doc) => {
            fetchedUsers.push({ ...doc.data(), id: doc.id });
          });
          setActiveUsers(fetchedUsers);
        }, (error) => {
          setModalMessage("Error fetching active users.");
          console.error("Error fetching active users:", error);
        });

        return () => unsubscribe();
      }, [isAdmin]);

      // Function to add or update an event
      const handleAddOrUpdateEvent = async (e) => {
        e.preventDefault();
        if (!newEventTitle || !newEventDate || !newEventDescription) {
          setModalMessage("Please fill in all event details.");
          return;
        }
        
        const [year, month, day] = newEventDate.split('-').map(Number);
        const [hours, minutes] = newEventTime.split(':').map(Number);
        const eventDate = new Date(year, month - 1, day, hours, minutes);

        if (isNaN(eventDate)) {
          setModalMessage("Invalid date or time format.");
          return;
        }

        try {
          const eventsCollectionPath = `/artifacts/${firebaseConfig.projectId}/public/data/calendarEvents`;
          if (editingEvent) {
            // Update existing event and preserve registered users
            const eventRef = doc(db, eventsCollectionPath, editingEvent.id);
            await updateDoc(eventRef, {
              title: newEventTitle,
              date: eventDate,
              description: newEventDescription,
              category: newEventCategory,
              tags: newEventTags,
              totalVolunteers: parseInt(newEventVolunteers, 10),
              registeredUsers: editingEvent.registeredUsers || [] // Preserve existing users
            });
            setEditingEvent(null);
          } else {
            // Add new event
            await addDoc(collection(db, eventsCollectionPath), {
              title: newEventTitle,
              date: eventDate,
              description: newEventDescription,
              category: newEventCategory,
              tags: newEventTags,
              totalVolunteers: parseInt(newEventVolunteers, 10),
              createdAt: serverTimestamp(),
              registeredUsers: []
            });
          }
          setNewEventTitle('');
          setNewEventDate('');
          setNewEventTime('12:00');
          setNewEventDescription('');
          setNewEventCategory('Work');
          setNewEventTags('');
          setNewEventVolunteers(0);
        } catch (error) {
          setModalMessage("Error adding/updating event.");
          console.error("Error adding/updating event: ", error);
        }
      };
      
      const handleEditEvent = (event) => {
        setAdminTab('create');
        setEditingEvent(event);
        setNewEventTitle(event.title);
        setNewEventDate(event.date.toDate().toISOString().split('T')[0]);
        setNewEventTime(event.date.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }));
        setNewEventDescription(event.description);
        setNewEventCategory(event.category);
        setNewEventTags(event.tags);
        setNewEventVolunteers(event.totalVolunteers);
      };

      // Function to delete an event
      const handleDeleteEvent = () => {
        setModalMessage("Are you sure you want to delete this event?");
        setShowConfirm(true);
        setModalAction(() => async () => {
          if (!editingEvent) return;
          try {
            const eventsCollectionPath = `/artifacts/${firebaseConfig.projectId}/public/data/calendarEvents`;
            const eventRef = doc(db, eventsCollectionPath, editingEvent.id);
            await deleteDoc(eventRef);
            setEditingEvent(null);
            setNewEventTitle('');
            setNewEventDate('');
            setNewEventTime('12:00');
            setNewEventDescription('');
            setNewEventCategory('Work');
            setNewEventTags('');
            setNewEventVolunteers(0);
            setModalMessage("Event deleted successfully.");
            setShowConfirm(false);
          } catch (error) {
            setModalMessage("Error deleting event.");
            console.error("Error deleting event: ", error);
          }
        });
      };
      
      const handleAddTag = async (e) => {
        e.preventDefault();
        if (!newTagName) {
          setModalMessage("Tag name cannot be empty.");
          return;
        }
        try {
          await addDoc(collection(db, `/artifacts/${firebaseConfig.projectId}/public/data/eventTags`), {
            name: newTagName,
            color: newTagColor,
          });
          setNewTagName('');
          setNewTagColor('#000000');
        } catch (error) {
          setModalMessage("Error adding tag.");
          console.error("Error adding tag:", error);
        }
      };

      const handleAddCategory = async (e) => {
        e.preventDefault();
        if (!newCategoryName) {
          setModalMessage("Category name cannot be empty.");
          return;
        }
        try {
          await addDoc(collection(db, `/artifacts/${firebaseConfig.projectId}/public/data/eventCategories`), {
            name: newCategoryName,
            color: newCategoryColor,
          });
          setNewCategoryName('');
          setNewCategoryColor('#000000');
        } catch (error) {
          setModalMessage("Error adding category.");
          console.error("Error adding category:", error);
        }
      };

      const handleDeleteTag = async (id) => {
        setModalMessage("Are you sure you want to delete this tag?");
        setShowConfirm(true);
        setModalAction(() => async () => {
          try {
            await deleteDoc(doc(db, `/artifacts/${firebaseConfig.projectId}/public/data/eventTags`, id));
            setModalMessage("Tag deleted.");
            setShowConfirm(false);
          } catch (error) {
            setModalMessage("Error deleting tag.");
            console.error("Error deleting tag:", error);
          }
        });
      };

      const handleDeleteCategory = async (id) => {
        setModalMessage("Are you sure you want to delete this category?");
        setShowConfirm(true);
        setModalAction(() => async () => {
          try {
            await deleteDoc(doc(db, `/artifacts/${firebaseConfig.projectId}/public/data/eventCategories`, id));
            setModalMessage("Category deleted.");
            setShowConfirm(false);
          } catch (error) {
            setModalMessage("Error deleting category.");
            console.error("Error deleting category:", error);
          }
        });
      };
      
      // Helper functions for calendar generation
      const getDaysInMonth = (year, month) => {
        return new Date(year, month + 1, 0).getDate();
      };

      const getFirstDayOfMonth = (year, month) => {
        return new Date(year, month, 1).getDay();
      };

      const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      // Function to render the calendar grid
      const renderCalendar = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const numDays = getDaysInMonth(year, month);
        const firstDay = getFirstDayOfMonth(year, month);
        const calendarDays = [];

        for (let i = 0; i < firstDay; i++) {
          calendarDays.push(<div key={`empty-${i}`} className="p-2 sm:p-4 text-center border border-slate-200"></div>);
        }

        for (let day = 1; day <= numDays; day++) {
          const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const dayEvents = events.filter(event => {
            const eventDate = event.date?.toDate();
            if (!eventDate) return false;
            const eventDateString = eventDate.toISOString().split('T')[0];
            return eventDateString === formattedDate;
          }).sort((a,b) => a.date.toDate() - b.date.toDate()); // Sort events by time

          calendarDays.push(
            <div key={day} className="p-2 sm:p-4 border border-slate-200 min-h-[100px] flex flex-col relative bg-[#C4CED4]">
              <span style={{ fontSize: '16px', fontFamily: 'Segoe UI' }} className="font-bold text-[#27251F] absolute top-2 left-2">{day}</span>
              {dayEvents.length > 0 && (
                <div className="mt-8 text-xs sm:text-sm space-y-1">
                  {dayEvents.map((event, index) => (
                    <div 
                      key={index} 
                      className="calendar-event" 
                      style={{ backgroundColor: categories.find(cat => cat.name === event.category)?.color || '#3B82F6' }}
                      title={event.title}
                      onClick={() => {
                        if (isAdmin) {
                          handleEditEvent(event);
                        } else {
                          setSelectedEvent(event);
                        }
                      }}
                    >
                      <span>{event.title}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          );
        }
        return calendarDays;
      };
      
      const handleAdminLogin = (username, password) => {
        const correctPassword = adminCredentials[username];
        if (correctPassword && correctPassword === password) {
          setIsAdmin(true);
          setShowAdminLoginModal(false);
        } else {
          setModalMessage("Incorrect username or password.");
        }
      };

      return (
        <div className="min-h-screen bg-[#27251F] p-4 sm:p-8 font-sans antialiased text-slate-800">
          <MessageModal 
            message={modalMessage} 
            onConfirm={() => {
              if (modalAction) modalAction();
              setModalMessage('');
            }}
            onCancel={() => {
              setModalMessage('');
              setShowConfirm(false);
              setModalAction(null);
            }}
            showConfirm={showConfirm}
          />
          {showAdminLoginModal && (
            <AdminLoginModal
              onLogin={handleAdminLogin}
              onClose={() => {
                setShowAdminLoginModal(false);
                setModalMessage('');
              }}
              modalMessage={modalMessage}
              setModalMessage={setModalMessage}
            />
          )}
          {selectedEvent && <EventDetailsModal event={selectedEvent} onClose={() => setSelectedEvent(null)} userId={userId} isAdmin={isAdmin} categories={categories} tags={tags} />}
          
          {/* Header */}
          <div className="max-w-7xl mx-auto bg-[#C4CED4] p-6 rounded-xl shadow-lg flex items-center justify-between mb-8">
            <div className="flex items-center space-x-4">
              {/* Logo Placeholder */}
              <div className="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                Logo
              </div>
              <div>
                <h1 className="text-3xl font-extrabold tracking-tight text-[#27251F]">
                  My Event Calendar
                </h1>
                <p className="text-sm text-slate-500">
                  Testing AI ability to create an application
                </p>
              </div>
            </div>
            {isAdmin ? (
              <button
                onClick={() => {setIsAdmin(false);}}
                className="px-4 py-2 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 transition-colors"
              >
                Log Out
              </button>
            ) : (
              <button
                onClick={() => setShowAdminLoginModal(true)}
                className="px-4 py-2 text-white font-semibold rounded-lg shadow-md transition-colors bg-custom-green hover:bg-green-700"
              >
                Admin
              </button>
            )}
          </div>

          <div className="max-w-7xl mx-auto bg-[#C4CED4] p-6 sm:p-10 rounded-xl shadow-lg">
            {/* Calendar Controls */}
            <div className="flex justify-between items-center mb-6 sm:mb-8 border-b-2 pb-4">
              <div className="text-xl sm:text-3xl font-bold self-center text-[#27251F]">
                {currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}
              </div>
              <div className="flex space-x-2">
                <button
                  onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))}
                  className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors"
                >
                  Previous
                </button>
                <button
                  onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))}
                  className="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors"
                >
                  Next
                </button>
              </div>
            </div>

            {/* Calendar Grid */}
            <div className="grid grid-cols-7 gap-1 text-center">
              {daysOfWeek.map(day => (
                <div key={day} className="font-bold text-lg sm:text-xl text-white py-2 border-b-2 border-slate-300 bg-[#27251F]">{day}</div>
              ))}
              {renderCalendar()}
            </div>

            {/* Admin Interface */}
            {isAdmin && (
              <div className="mt-8 border-t-2 pt-6">
                <h3 className="text-2xl sm:text-3xl font-bold text-blue-600 mb-4">Admin Panel</h3>
                <div className="mb-4">
                  <p className="text-sm text-slate-500">User ID: <span className="font-mono bg-slate-200 p-1 rounded text-xs">{userId || 'Loading...'}</span></p>
                </div>
                <div className="flex flex-wrap border-b-2 mb-4">
                  <button onClick={() => setAdminTab('create')} className={`px-4 py-2 font-semibold ${adminTab === 'create' ? 'border-b-2 border-blue-600' : ''}`}>Create New Event</button>
                  <button onClick={() => setAdminTab('signups')} className={`px-4 py-2 font-semibold ${adminTab === 'signups' ? 'border-b-2 border-blue-600' : ''}`}>View All Signups</button>
                  <button onClick={() => setAdminTab('tags')} className={`px-4 py-2 font-semibold ${adminTab === 'tags' ? 'border-b-2 border-blue-600' : ''}`}>Manage Tags</button>
                  <button onClick={() => setAdminTab('categories')} className={`px-4 py-2 font-semibold ${adminTab === 'categories' ? 'border-b-2 border-blue-600' : ''}`}>Manage Categories</button>
                </div>

                {adminTab === 'create' && (
                  <form onSubmit={handleAddOrUpdateEvent} className="flex flex-col space-y-4">
                    <input
                      type="text"
                      placeholder="Event Title"
                      value={newEventTitle}
                      onChange={(e) => setNewEventTitle(e.target.value)}
                      className="p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <div className="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                      <input
                        type="date"
                        value={newEventDate}
                        onChange={(e) => setNewEventDate(e.target.value)}
                        className="flex-grow p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <input
                        type="time"
                        value={newEventTime}
                        onChange={(e) => setNewEventTime(e.target.value)}
                        className="p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <select
                        value={newEventCategory}
                        onChange={(e) => setNewEventCategory(e.target.value)}
                        className="p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        {categories.map(category => (
                          <option key={category.id} value={category.name}>{category.name}</option>
                        ))}
                      </select>
                      <input
                        type="number"
                        placeholder="Total Volunteers"
                        value={newEventVolunteers}
                        onChange={(e) => setNewEventVolunteers(e.target.value)}
                        min="0"
                        className="p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <textarea
                      placeholder="Description"
                      value={newEventDescription}
                      onChange={(e) => setNewEventDescription(e.target.value)}
                      className="p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <select
                      value={newEventTags}
                      onChange={(e) => setNewEventTags(e.target.value)}
                      className="p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="">Select Tag</option>
                      {tags.map(tag => (
                        <option key={tag.id} value={tag.name}>{tag.name}</option>
                      ))}
                    </select>
                    <div className="flex space-x-4">
                      <button
                        type="submit"
                        className="flex-grow px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors"
                      >
                        {editingEvent ? 'Update Event' : 'Add Event'}
                      </button>
                      {editingEvent && (
                        <button
                          onClick={handleDeleteEvent}
                          className="flex-grow px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors"
                        >
                          Delete Event
                        </button>
                      )}
                      {editingEvent && (
                        <button
                          onClick={() => {
                            setEditingEvent(null);
                            setNewEventTitle('');
                            setNewEventDate('');
                            setNewEventTime('12:00');
                            setNewEventDescription('');
                            setNewEventCategory('Work');
                            setNewEventTags('');
                            setNewEventVolunteers(0);
                          }}
                          className="flex-grow px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors"
                        >
                          Cancel
                        </button>
                      )}
                    </div>
                  </form>
                )}

                {adminTab === 'signups' && (
                  <div className="space-y-6">
                    <h3 className="text-xl font-bold mb-4">View All Signups</h3>
                    {events.length > 0 ? (
                      events.map(event => (
                        <div key={event.id} className="border p-4 rounded-lg shadow-md bg-slate-50">
                          <h4 className="font-bold text-lg mb-2">{event.title}</h4>
                          <p className="text-sm text-slate-500 mb-2">
                            {event.date.toDate().toLocaleString()}
                          </p>
                          <h5 className="font-semibold mt-4">Registered Volunteers ({event.registeredUsers ? event.registeredUsers.length : 0})</h5>
                          {event.registeredUsers && event.registeredUsers.length > 0 ? (
                            <ul className="mt-2 list-disc list-inside space-y-1 text-sm">
                              {event.registeredUsers.map((user, index) => (
                                <li key={index}>{user.name} ({user.email})</li>
                              ))}
                            </ul>
                          ) : (
                            <p className="text-sm text-slate-500">No volunteers registered yet.</p>
                          )}
                        </div>
                      ))
                    ) : (
                      <p className="text-center text-slate-500">No events found.</p>
                    )}
                  </div>
                )}
                
                {adminTab === 'tags' && (
                  <div className="space-y-6">
                    <h3 className="text-xl font-bold mb-4">Manage Tags</h3>
                    <form onSubmit={handleAddTag} className="flex space-x-2">
                      <input
                        type="text"
                        placeholder="New Tag Name"
                        value={newTagName}
                        onChange={(e) => setNewTagName(e.target.value)}
                        className="flex-grow p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <input
                        type="color"
                        value={newTagColor}
                        onChange={(e) => setNewTagColor(e.target.value)}
                        className="p-2 border border-slate-300 rounded-lg"
                      />
                      <button type="submit" className="px-6 py-3 text-white font-semibold rounded-lg shadow-md transition-colors bg-custom-green hover:bg-green-700">Add Tag</button>
                    </form>
                    <div className="mt-4">
                      <h4 className="font-semibold mb-2">Existing Tags:</h4>
                      <ul className="flex flex-wrap gap-2">
                        {tags.map(tag => (
                          <li key={tag.id} className="flex items-center space-x-2 p-2 rounded-lg bg-slate-100">
                            <span style={{ backgroundColor: tag.color }} className="w-4 h-4 rounded-full"></span>
                            <span>{tag.name}</span>
                            <button onClick={() => handleDeleteTag(tag.id)} className="text-red-500 hover:text-red-700">x</button>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </div>
                )}

                {adminTab === 'categories' && (
                  <div className="space-y-6">
                    <h3 className="text-xl font-bold mb-4">Manage Categories</h3>
                    <form onSubmit={handleAddCategory} className="flex space-x-2">
                      <input
                        type="text"
                        placeholder="New Category Name"
                        value={newCategoryName}
                        onChange={(e) => setNewCategoryName(e.target.value)}
                        className="flex-grow p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <input
                        type="color"
                        value={newCategoryColor}
                        onChange={(e) => setNewCategoryColor(e.target.value)}
                        className="p-2 border border-slate-300 rounded-lg"
                      />
                      <button type="submit" className="px-6 py-3 text-white font-semibold rounded-lg shadow-md transition-colors bg-custom-green hover:bg-green-700">Add Category</button>
                    </form>
                    <div className="mt-4">
                      <h4 className="font-semibold mb-2">Existing Categories:</h4>
                      <ul className="flex flex-wrap gap-2">
                        {categories.map(category => (
                          <li key={category.id} className="flex items-center space-x-2 p-2 rounded-lg bg-slate-100">
                            <span style={{ backgroundColor: category.color }} className="w-4 h-4 rounded-full"></span>
                            <span>{category.name}</span>
                            <button onClick={() => handleDeleteCategory(category.id)} className="text-red-500 hover:text-red-700">x</button>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </div>
                )}
                
                {/* Active Users List for Admin */}
                <div className="mt-8 border-t-2 pt-6">
                  <h3 className="text-xl font-bold mb-4">Active Users</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full text-left table-auto">
                      <thead>
                        <tr className="bg-slate-200">
                          <th className="p-2 border-b-2 border-slate-300">User ID</th>
                          <th className="p-2 border-b-2 border-slate-300">Last Login</th>
                        </tr>
                      </thead>
                      <tbody>
                        {activeUsers.length > 0 ? (
                          activeUsers.map((user) => (
                            <tr key={user.id} className="hover:bg-slate-50 transition-colors">
                              <td className="p-2 border-b">{user.id}</td>
                              <td className="p-2 border-b">
                                {user.lastLogin ? user.lastLogin.toDate().toLocaleString() : 'N/A'}
                              </td>
                            </tr>
                          ))
                        ) : (
                          <tr>
                            <td colSpan="2" className="p-2 text-center text-slate-500">
                              No active users found.
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);
    root.render(React.createElement(App));
  </script>
</body>
</html>
